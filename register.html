<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>東吳大學學生會</title>
    <!-- 主要站點的 CSS -->
    <link rel="stylesheet" href="sa.css">
    <link rel="icon" href="favicon.PNG" type="image/x-icon">

    <style>
         /* New CSS Variables for Dark Theme */
        :root {
            --text-light: #f0f0f0;         /* 淺色文字 */
            --text-white: #ffffff;         /* 白色文字 */
            --sidebar-bg: #181818;         /* 側邊欄背景 */
            --main-bg: #010010;            /* 主背景色 */
            --border-color: #455b76;       /* 邊框顏色 */
            --link-hover: rgb(205, 47, 71); /* 連結懸停顏色 */
            --link-color: #6887ae;         /* 一般連結顏色 */

            /* 新增/調整的顏色變數 (從註冊頁面複製) */
            --form-bg: rgba(24, 24, 24, 0.9); /* 表單背景，稍微透明 */
            --form-border: rgba(69, 91, 118, 0.6); /* 表單邊框，稍微透明 */
            --input-bg: rgba(255, 255, 255, 0.08); /* 輸入框背景，微透明 */
            --input-border: rgba(69, 91, 118, 0.4); /* 輸入框邊框，微透明 */
            --input-focus-border: var(--link-color); /* 輸入框聚焦邊框 */
            --input-text: var(--text-light); /* 輸入框文字顏色 */
            --placeholder-color: rgba(240, 240, 240, 0.5); /* 佔位符文字顏色 */
            --error-color: #e57373;        /* 錯誤訊息顏色 (較柔和的紅) */
            --success-color: #81c784;      /* 成功訊息顏色 (較柔和的綠) */
            --warning-color: #ffb74d;      /* 警告顏色 (橘色) */
            --modal-bg: var(--main-bg); /* 彈窗內容背景 */
            --modal-header-bg: var(--sidebar-bg); /* 彈窗頭部背景 */
            --modal-footer-bg: var(--sidebar-bg); /* 彈窗底部背景 */
        }

        /* Global Styles */
        body {
            margin: 0;
            padding: 0;
            font-family: 'Arial', sans-serif;
            background-color: var(--main-bg); /* Apply main background */
            color: var(--text-light); /* Apply light text color globally */
        }

        /* Ensure the Three.js background covers the body */
        #constellation-bg {
             position: fixed;
             top: 0;
             left: 0;
             width: 100%;
             height: 100%;
             z-index: 0; /* Keep background behind content */
        }

        .Icontainer {
            width: 100%;
            max-width: 450px;
            background-color: var(--form-bg); /* Use form background */
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5); /* Darker shadow for dark theme */
            border: 1px solid var(--form-border); /* Add border using variable */
            padding: 30px;
            position: relative;
            z-index: 1;
            overflow: hidden;
            transition: transform 0.3s ease, box-shadow 0.3s ease, border-color 0.3s ease;
            margin: 5vh auto 20px auto; /* Center, add margin below */
        }

        .Icontainer:hover {
            transform: translateY(-5px) scale(1.01);
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.6); /* Darker hover shadow */
            border-color: var(--link-color); /* Highlight border on hover */
        }

        h1 {
            text-align: center;
            margin-bottom: 30px;
            color: var(--text-white); /* White title */
            position: relative;
            padding-bottom: 15px;
        }

        h1::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 60px;
            height: 3px;
            background-color: var(--link-color); /* Accent color underline */
            transition: width 0.3s ease;
        }

        .container:hover h1::after {
            width: 100px;
        }

        .form-group {
            margin-bottom: 20px;
            position: relative;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: var(--text-light); /* Label color */
            font-weight: 500;
            transition: color 0.3s ease;
        }

        .form-group:focus-within label {
            color: var(--link-color); /* Label color when input is focused */
        }

        .form-control {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid var(--input-border); /* Input border */
            border-radius: 6px;
            font-size: 16px;
            transition: all 0.3s ease;
            outline: none;
            background-color: var(--input-bg); /* Input background */
            color: var(--input-text); /* Input text color */
        }

        .form-control::placeholder {
            color: var(--placeholder-color); /* Placeholder color */
            opacity: 1; /* Ensure placeholder is visible */
        }

        .form-control:focus {
            border-color: var(--input-focus-border); /* Focus border color */
            box-shadow: 0 0 0 3px rgba(104, 135, 174, 0.3); /* Shadow based on link-color */
            background-color: var(--input-bg); /* Keep same background or slightly lighter if desired */
        }

        .form-error {
            color: var(--error-color); /* Error text color */
            font-size: 14px;
            margin-top: 5px;
            transition: all 0.3s ease;
            max-height: 0;
            overflow: hidden;
        }

        .form-error.active {
            max-height: 50px;
            margin-top: 5px;
        }

        .btn {
            display: block;
            width: 100%;
            padding: 14px;
            background-color: var(--link-color); /* Button background using accent color */
            color: var(--text-white); /* Button text color */
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .btn:hover {
            background-color: var(--link-hover); /* Button hover background */
        }

        .btn:active {
            transform: scale(0.98);
        }

        .btn::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 5px;
            height: 5px;
            background: rgba(255, 255, 255, 0.5);
            opacity: 0;
            border-radius: 100%;
            transform: scale(1, 1) translate(-50%);
            transform-origin: 50% 50%;
        }

        .btn:focus:not(:active)::after {
            animation: ripple 1s ease-out;
        }

        @keyframes ripple {
            0% {
                transform: scale(0, 0);
                opacity: 0.5;
            }
            100% {
                transform: scale(20, 20);
                opacity: 0;
            }
        }

        /* --- Login Link Area --- */
        .login-link-area {
            text-align: center;
            margin-top: 20px; /* Space above the link */
            color: var(--text-light); /* Text color */
            z-index: 1; /* Ensure it's above the background */
            position: relative; /* Needed for z-index */
        }

        .login-link-area a {
            color: var(--link-color); /* Link color */
            text-decoration: none;
            font-weight: 600;
            transition: color 0.3s ease, text-decoration 0.3s ease;
        }

        .login-link-area a:hover {
            color: var(--link-hover); /* Link hover color */
            text-decoration: underline;
        }


        /* Enhanced Terms Modal Styling */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.85); /* Darker overlay */
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.4s cubic-bezier(0.165, 0.84, 0.44, 1);
        }

        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .modal-container {
            background-color: var(--modal-bg); /* Use modal background */
            color: var(--text-light); /* Apply text color inside modal */
            width: 90%;
            max-width: 550px;
            max-height: 85vh;
            border-radius: 12px;
            padding: 0;
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.5); /* Darker shadow */
            transform: translateY(-30px) scale(0.95);
            transition: all 0.4s cubic-bezier(0.165, 0.84, 0.44, 1);
            overflow: hidden;
        }

        .modal-overlay.active .modal-container {
            transform: translateY(0) scale(1);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 30px;
            background-color: var(--modal-header-bg); /* Use modal header background */
            color: var(--text-white); /* Header text color */
            border-bottom: none; /* Remove border */
        }

        .modal-title {
            font-size: 24px;
            color: var(--text-white); /* Header title color */
            margin: 0;
            font-weight: 600;
        }

        .modal-content {
            padding: 25px 30px;
            max-height: 60vh;
            overflow-y: auto;
            line-height: 1.6;
            scrollbar-width: thin;
            scrollbar-color: var(--link-color) var(--modal-bg); /* Scrollbar colors */
        }

        .modal-content::-webkit-scrollbar {
            width: 8px;
        }

        .modal-content::-webkit-scrollbar-track {
            background: var(--modal-bg); /* Scrollbar track */
            border-radius: 4px;
        }

        .modal-content::-webkit-scrollbar-thumb {
            background-color: var(--link-color); /* Scrollbar thumb */
            border-radius: 4px;
        }

        /* Password warning section */
        .password-warning {
            background-color: var(--sidebar-bg); /* Darker background for warning */
            border-left: 5px solid var(--error-color); /* Error color border */
            padding: 15px 20px;
            margin: 20px 0;
            border-radius: 4px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.3); /* Darker shadow */
            transition: all 0.3s ease;
        }

        .password-warning:hover {
            transform: translateX(3px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.4); /* Darker hover shadow */
        }

        .password-warning h2 {
            color: var(--warning-color); /* Warning title color */
            margin-top: 0;
            font-size: 1.3rem;
            display: flex;
            align-items: center;
        }

        .password-warning h3 {
            color: var(--text-light); /* Warning text color */
            font-size: 1rem;
            font-weight: 500;
            margin-bottom: 0;
        }

        /* Terms sections styling */
        .terms-section {
            margin: 20px 0;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(69, 91, 118, 0.4); /* Border based on variable */
            transition: all 0.3s ease;
        }

        .terms-section:hover {
            padding-left: 5px;
        }

        .terms-section:last-child {
            border-bottom: none;
        }

        .terms-section h3 {
            color: var(--link-color); /* Section title color */
            font-size: 1.1rem;
            margin-bottom: 10px;
            position: relative;
            padding-left: 22px;
        }

        .terms-section h3:before {
            content: "";
            position: absolute;
            left: 0;
            top: 50%;
            transform: translateY(-50%);
            width: 12px;
            height: 12px;
            background-color: var(--link-color); /* Bullet color */
            border-radius: 50%;
        }

        .terms-section p {
            margin: 10px 0 10px 22px;
            color: var(--text-light); /* Paragraph text color */
        }

        /* Contact section */
        .contact-section {
            background-color: var(--sidebar-bg); /* Dark background */
            padding: 15px 20px;
            border-radius: 4px;
            margin: 20px 0 10px;
        }

        .contact-section a {
            color: var(--link-color); /* Link color */
            text-decoration: none;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .contact-section a:hover {
            color: var(--link-hover); /* Link hover color */
            text-decoration: underline;
        }

        .modal-footer {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 20px 30px;
            background-color: var(--modal-footer-bg); /* Use modal footer background */
            border-top: 1px solid rgba(69, 91, 118, 0.4); /* Border color */
        }

        .checkbox-container {
            display: flex;
            align-items: center;
            cursor: pointer;
            user-select: none;
        }

        /* Custom checkbox styling */
        .custom-checkbox {
            position: relative;
            display: inline-block;
            width: 20px;
            height: 20px;
            margin-right: 12px;
        }

        .custom-checkbox input {
            position: absolute;
            opacity: 0;
            cursor: pointer;
            height: 0;
            width: 0;
        }

        .checkmark {
            position: absolute;
            top: 0;
            left: 0;
            height: 20px;
            width: 20px;
            background-color: var(--input-bg); /* Checkbox background */
            border: 2px solid var(--border-color); /* Checkbox border */
            border-radius: 4px;
            transition: all 0.3s ease;
        }

        .custom-checkbox:hover input ~ .checkmark {
            border-color: var(--link-color); /* Hover border color */
        }

        .custom-checkbox input:checked ~ .checkmark {
            background-color: var(--link-color); /* Checked background color */
            border-color: var(--link-color); /* Checked border color */
        }

        .checkmark:after {
            content: "";
            position: absolute;
            display: none;
            left: 6px;
            top: 2px;
            width: 5px;
            height: 10px;
            border: solid var(--text-white); /* Checkmark color */
            border-width: 0 2px 2px 0;
            transform: rotate(45deg);
        }

        .custom-checkbox input:checked ~ .checkmark:after {
            display: block;
        }

        .checkbox-label {
            color: var(--text-light); /* Label color */
            font-weight: 500;
            transition: color 0.3s ease;
        }

        .custom-checkbox input:checked ~ .checkbox-label {
            color: var(--text-white); /* Label color when checked */
        }

        .close-modal {
            padding: 10px 22px;
            background-color: var(--border-color); /* Button background */
            color: var(--text-white); /* Button text color */
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            opacity: 0.6;
            pointer-events: none;
        }

        .close-modal.active {
            background-color: var(--link-color); /* Active background */
            color: var(--text-white);
            opacity: 1;
            pointer-events: all;
            box-shadow: 0 4px 8px rgba(104, 135, 174, 0.3); /* Shadow based on link-color */
        }

        .close-modal.active:hover {
            background-color: var(--link-hover); /* Hover background */
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(205, 47, 71, 0.4); /* Shadow based on link-hover */
        }

        .close-modal.active:active {
            transform: translateY(0);
            box-shadow: 0 2px 4px rgba(205, 47, 71, 0.2); /* Shadow based on link-hover */
        }

        /* Animations (ripple) - color might be affected by --text-white or change */
        /* Current ripple uses white rgba, which is fine on dark bg */

        /* For mobile responsiveness */
        @media (max-width: 576px) {
            .modal-container {
                width: 95%;
                max-height: 90vh;
            }

            .modal-header {
                padding: 15px 20px;
            }

            .modal-title {
                font-size: 20px;
            }

            .modal-content {
                padding: 20px;
            }

            .modal-footer {
                padding: 15px 20px;
                flex-direction: column;
                gap: 15px;
            }

            .checkbox-container {
                margin-right: 0;
                margin-bottom: 10px;
            }

            .close-modal {
                width: 100%;
            }
        }

        /* Loading indicator */
        .loader {
            display: none; /* Initially hidden */
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 16, 0.95); /* Darker loader bg */
            z-index: 9999; /* Highest z-index */
            justify-content: center;
            align-items: center;
        }

        .loader-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid rgba(104, 135, 174, 0.3); /* Border based on link-color */
            border-radius: 50%;
            border-top-color: var(--link-color); /* Spinner color */
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            100% {
                transform: rotate(360deg);
            }
        }

        /* Verification Code Area */
        .verification-area {
            display: none; /* Initially hidden */
            text-align: center;
            padding: 20px;
            background-color: var(--modal-bg); /* Use modal background */
            border-radius: 8px;
            margin-top: 20px;
            transform: translateY(-10px);
            opacity: 0;
            transition: all 0.5s ease;
             color: var(--text-light); /* Text color */
        }

        .verification-area.active {
            display: block;
            transform: translateY(0);
            opacity: 1;
        }

        .verification-area h3 {
            color: var(--link-color); /* Title color */
            margin-bottom: 15px;
        }

        .verification-area p {
             color: var(--text-light); /* Paragraph color */
             margin-bottom: 20px;
        }

        .verification-area .form-group {
            margin-bottom: 0;
        }

         /* Style for the verification input */
         .verification-input {
             text-align: center;
         }

         /* Style for general message area */
         .message-area {
            display: none; /* Initially hidden */
            text-align: center;
            padding: 20px;
            background-color: var(--modal-bg); /* Use modal background */
            border-radius: 8px;
            margin-top: 20px;
            transform: translateY(-10px);
            opacity: 0;
            transition: all 0.5s ease;
             color: var(--text-light); /* Default text color */
         }

         .message-area.active {
            display: block;
            transform: translateY(0);
            opacity: 1;
         }

         .message-area h3 {
             color: var(--link-color); /* Default title color */
             margin-bottom: 15px;
         }

         .message-area p {
             color: var(--text-light); /* Default paragraph color */
         }

         .message-area.error h3,
         .message-area.error p {
             color: var(--error-color); /* Error color for messages */
         }

        /* Registration Success Message */
        .success-message {
            display: none; /* Initially hidden */
            text-align: center;
            padding: 20px;
            background-color: var(--sidebar-bg); /* Use a dark theme background */
            border-radius: 8px;
            color: var(--success-color); /* Success color */
            margin-top: 20px;
            transform: translateY(-10px);
            opacity: 0;
            transition: all 0.5s ease;
            border: 1px solid var(--success-color); /* Add a success border */
        }

        .success-message.active {
            display: block;
            transform: translateY(0);
            opacity: 1;
        }

        .success-icon {
            display: inline-block;
            font-size: 48px;
            margin-bottom: 15px;
            color: var(--success-color); /* Icon color */
        }

        /* Ensure the logo looks okay on dark backgrounds */
        #logo {
            width: 45px;
            height: 45px;
            /* Add some styling if needed for dark theme contrast */
            /* filter: invert(1); */ /* Example: if logo is dark, invert it */
        }



    </style>
</head>

<body>
    <div class="container">
        <!-- 漢堡選單按鈕 -->
        <div class="hamburger-menu" id="hamburger-menu">
            <span></span>
            <span></span>
            <span></span>
        </div>

        <!-- 手機版側邊欄 -->
        <nav class="sidebar" id="sidebar">
            <div class="logo">
                <img src="logo.png" alt="Logo">
                <div class="site-name"></div>
            </div>
            <ul class="nav-links" id="mobile-nav">
                <!-- 動態加載的導航項目將插入此處 -->
            </ul>
        </nav>

        <div class="main-content">
            <!-- 桌面版導航欄 -->
            <div class="navbar">
                <ul class="nav-options" id="nav-container">
                    <!-- 動態加載的導航項目將插入此處 -->
                </ul>
            </div>


    <!-- The updated HTML for the terms modal section -->
    <div class="modal-overlay active" id="termsModal">
        <div class="modal-container">
            <div class="modal-header">
                <h2 class="modal-title">東吳大學學生會帳號註冊同意書</h2>
                 <img src="favicon.png" alt="Logo" id="logo">
            </div>
            <div class="modal-content">
                <p>歡迎您使用我們的服務！在使用前，請詳細閱讀以下條款。</p>
                <div class="password-warning">
                    <h2>密碼設定須知</h2>
                    <h3>註冊時所設定的密碼會直接傳到學生會的後台，不必與東吳大學校務行政系統的密碼相同，僅作為學生會服務所需的認證用途。為確保註冊的學生擁有東吳大學的學生資格，註冊過程中會使用學校電子郵件驗證<a href="https://webmail.scu.edu.tw/" target="_blank" style="color: #d5e2e6;"> webmail.scu.edu.tw</a>（帳號密碼預設皆為學號8碼），請先準備以完成驗證程序。</h3>
                </div>
                <div class="terms-section">
                    <h3>個人資料的收集與使用</h3>
                    <p>我會收集您的學號及相關資訊，這些資訊將用於您的帳戶管理、服務提供、及安全維護。我們也會收集您的IP地址以防止濫用。</p>
                </div>
                <div class="terms-section">
                    <h3>資料安全</h3>
                    <p>我將採取合理的安全措施保護您的個人資料，避免未經授權的存取、使用或洩露。所有密碼都會經過加密處理。</p>
                </div>
                <div class="terms-section">
                    <h3>用戶責任</h3>
                    <p>您必須妥善保管您的帳號密碼，並對使用該帳號進行的所有活動負責。若發現任何安全問題，請立即通知我們。</p>
                </div>
                <div class="terms-section">
                    <h3>條款變更</h3>
                    <p>我們保留隨時修改這些條款的權利。修改後的條款將在網站上公佈。您繼續使用我們的服務，即表示您接受修改後的條款。</p>
                </div>
                <div class="terms-section">
                    <h3>詐騙防範提醒</h3>
                    <p>學生會絕對不會以任何形式（如電子郵件、電話等）要求學生提供網路ATM帳號或其他電信服務帳戶資訊。若您收到任何要求您提供此類信息的訊息，請立即提高警覺，並避免回應。</p>
                </div>
                <div class="contact-section">
                    <h3>聯絡我們</h3>
                    <p>如果有任何問題，歡迎直接連絡我們 <a href="mailto:scusa000@gmail.com">scusa000@gmail.com</a></p>
                </div>
            </div>
            <div class="modal-footer">
                <label class="checkbox-container">
                    <span class="custom-checkbox">
                        <input type="checkbox" id="termsCheckbox">
                        <span class="checkmark"></span>
                    </span>
                    <span class="checkbox-label">我已閱讀並同意上述條款</span>
                </label>
                <button class="close-modal" id="closeModal">確認</button>
            </div>
        </div>
    </div>

    <!-- 註冊表單區域 -->
    <div class="Icontainer" id="registrationContainer">
        <!-- Title dynamically changed by JS -->
        <h1 id="formTitle">創建帳號</h1>

        <!-- Step 1: Student ID/Password Form -->
        <form id="registrationForm" autocomplete="off">
            <div class="form-group">
                <label for="studentId">學號</label>
                <!-- Changed type to text, added inputmode, pattern, maxlength, updated id and placeholder -->
                <input type="text" class="form-control" id="studentId" name="entry.236193576" placeholder="請輸入您的8碼學號" required inputmode="numeric" pattern="\d{8}" maxlength="8">
                <div class="form-error" id="studentIdError"></div> <!-- Updated error id -->
            </div>
            <div class="form-group">
                <label for="password">密碼</label>
                 <!-- Added inputmode, maxlength, updated placeholder -->
                <input type="password" class="form-control" id="password" name="entry.1800516097" placeholder="請輸入4碼數字密碼" required inputmode="numeric" maxlength="4">
                <div class="form-error" id="passwordError"></div>
            </div>
            <div class="form-group">
                <label for="confirmPassword">確認密碼</label>
                <!-- Added inputmode, maxlength, updated placeholder -->
                <input type="password" class="form-control" id="confirmPassword" placeholder="請再次輸入4碼數字密碼" required inputmode="numeric" maxlength="4">
                <div class="form-error" id="confirmPasswordError"></div>
            </div>
            <input type="hidden" id="randomCode" name="entry.1005547065" value="">
            <input type="hidden" id="ipAddress" name="entry.7502784" value="">
            <button type="submit" class="btn" id="submitBtn">註冊</button>
        </form>

        <!-- Step 2: Verification Code Input Area -->
        <div class="verification-area" id="verificationArea">
            <!-- Updated text to reflect where verification code is sent -->
            <p>驗證碼已發送到您的學號所對應的電子信箱。<br><a href="https://webmail.scu.edu.tw/" target="_blank" style="color: #d5e2e6;"> webmail.scu.edu.tw</a><br>（帳號密碼預設皆為學號8碼）</p>
            <form id="verificationForm" autocomplete="off">
                <div class="form-group">
                    <label for="verificationCode">驗證碼</label>
                    <input type="text" class="form-control verification-input" id="verificationCode" name="entry.12374203" placeholder="請輸入收到的驗證碼" required>
                    <div class="form-error" id="verificationCodeError"></div>
                </div>
                <!-- Hidden field for the random code -->
                <input type="hidden" id="verificationRandomCode" name="entry.1779860337" value="">
                <button type="submit" class="btn" id="verifyBtn">驗證</button>
            </form>
        </div>

         <!-- Step 1.5 / 2.5 / Error: General Message Area -->
        <div class="message-area" id="messageArea">
            <h3 id="messageTitle"></h3>
            <p id="messageText"></p>
             <!-- Optional: Add a button to retry or go back -->
             <!-- <button class="btn" id="retryBtn" style="display: none; margin-top: 20px;">重試</button> -->
        </div>

        <!-- Step 3: Success Message -->
        <div class="success-message" id="successMessage">
            <div class="success-icon">✓</div>
            <h3>註冊成功！</h3>
            <p>您的帳號已經成功建立。</p>
        </div>

            <!-- Login Link Below Form -->
    <div class="login-link-area">
        <p>已有帳號？ <a href="login.html">立即登入</a></p>
    </div>
    </div>



    <!-- Loading indicator -->
    <div class="loader" id="loader">
        <div class="loader-spinner"></div>
    </div>


            <!-- 浮動球 -->
            <div id="ball-container">
                <img id="ball" src="ball7.gif" alt="Ball">
            </div>

            <div class="footer">
                <div class="footer-content">
                    <ul class="footer-links" id="footer-links">
                        <!-- 動態加載的底部鏈接將插入此處 -->
                    </ul>
                    <div class="footer-info">
                        © 2025 東吳大學學生會 版權所有
                    </div>
                </div>
            </div>
        </div>

    </div>

    <!-- 主要站點的 JavaScript -->
    <script src="sa.js"></script>
    <script src="sa0.js"></script>

  
    <script>
// --- LOGIN PAGE JS (MODIFIED FOR NETLIY FUNCTIONS) ---

// --- Helper Functions ---
function generateRandomCode(length) {
    const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
    let result = '';
    for (let i = 0; i < length; i++) {
        result += chars.charAt(Math.floor(Math.random() * chars.length));
    }
    return result;
}

async function getIPAddress() {
    try {
        const response = await fetch('https://api.ipify.org?format=json');
        const data = await response.json();
        return data.ip;
    } catch (error) {
        console.error('無法獲取IP地址', error);
        return '無法獲取IP地址';
    }
}

// --- DOM elements ---
const termsModal = document.getElementById('termsModal');
const termsCheckbox = document.getElementById('termsCheckbox');
const closeModalBtn = document.getElementById('closeModal');
const registrationContainer = document.getElementById('registrationContainer');
const formTitle = document.getElementById('formTitle');
const registrationForm = document.getElementById('registrationForm');
const verificationArea = document.getElementById('verificationArea');
const verificationForm = document.getElementById('verificationForm');
const messageArea = document.getElementById('messageArea');
const messageTitle = document.getElementById('messageTitle');
const messageText = document.getElementById('messageText');
const successMessage = document.getElementById('successMessage');
const loader = document.getElementById('loader');

// Step 1 form elements
const studentIdInput = document.getElementById('studentId');
const passwordInput = document.getElementById('password');
const confirmPasswordInput = document.getElementById('confirmPassword');
const studentIdError = document.getElementById('studentIdError');
const passwordError = document.getElementById('passwordError');
const confirmPasswordError = document.getElementById('confirmPasswordError');
const randomCodeField1 = document.getElementById('randomCode');
const ipAddressField = document.getElementById('ipAddress');

// Step 2 form elements
const verificationCodeInput = document.getElementById('verificationCode');
const verificationCodeError = document.getElementById('verificationCodeError');
const randomCodeField2 = document.getElementById('verificationRandomCode');

let currentRandomCode = '';

// --- [MODIFICATION]：Remove hardcoded URLs and IDs, declare variables to be filled ---
let verificationSheetId = '';
let verificationSheetUrl = '';
let registrationCheckSheetId = '';
let registrationCheckSheetUrl = '';
let registrationFormUrl = '';
let verificationFormUrl = '';

// --- Sheet Check Config ---
const verificationCheckInterval = 500;
const verificationMaxAttempts = Math.floor(100 * 1000 / verificationCheckInterval);
let verificationCheckAttempts = 0;
let verificationCheckIntervalId = null;

const registrationCheckInterval = 500;
const registrationMaxAttempts = Math.floor(100 * 1000 / registrationCheckInterval);
let registrationCheckAttempts = 0;
let registrationCheckIntervalId = null;

// --- [NEW]：Function to fetch configuration from Netlify Function ---
async function fetchConfig() {
    console.log('正在從伺服器獲取應用程式設定...');
    try {
        const response = await fetch('/.netlify/functions/get-config2');
        if (!response.ok) {
            throw new Error(`伺服器回應錯誤: ${response.status}`);
        }
        const config = await response.json();

        if (!config.registrationFormUrl || !config.verificationFormUrl || !config.verificationSheetId || !config.registrationCheckSheetId) {
            throw new Error('從伺服器收到的設定不完整。');
        }

        // Assign fetched values to our variables
        registrationFormUrl = config.registrationFormUrl;
        verificationFormUrl = config.verificationFormUrl;
        verificationSheetId = config.verificationSheetId;
        registrationCheckSheetId = config.registrationCheckSheetId;

        // Construct full sheet URLs from IDs
        verificationSheetUrl = `https://docs.google.com/spreadsheets/d/${verificationSheetId}/gviz/tq?tqx=out:csv`;
        registrationCheckSheetUrl = `https://docs.google.com/spreadsheets/d/${registrationCheckSheetId}/gviz/tq?tqx=out:csv`;

        console.log('應用程式設定已成功載入。');

        // Enable the first step's submit button
        const submitButton = document.getElementById('submitBtnStep1');
        if (submitButton) {
            submitButton.disabled = false;
            submitButton.textContent = '註冊'; // Restore button text
        }

    } catch (error) {
        console.error('載入設定失敗:', error);
        showMessage('初始化失敗', '無法載入應用程式設定，請重新整理頁面。', true);
        const submitButton = document.getElementById('submitBtnStep1');
        if (submitButton) {
            submitButton.disabled = true;
            submitButton.textContent = '載入失敗';
        }
    }
}

// --- Terms and Conditions Modal ---
if (termsCheckbox && closeModalBtn && termsModal) {
    termsCheckbox.addEventListener('change', function() {
        this.checked ? closeModalBtn.classList.add('active') : closeModalBtn.classList.remove('active');
    });
    closeModalBtn.addEventListener('click', function() {
        if (termsCheckbox.checked) {
            termsModal.classList.remove('active');
            setTimeout(() => { if (studentIdInput) studentIdInput.focus(); }, 300);
        }
    });
}

// --- Helper UI Functions ---
function showMessage(title, text, isError = false) {
    if (formTitle) formTitle.style.display = 'none';
    if (registrationForm) registrationForm.style.display = 'none';
    if (verificationArea) verificationArea.classList.remove('active');
    if (successMessage) successMessage.classList.remove('active');
    if (messageArea) {
        messageArea.classList.add('active');
        messageArea.classList.toggle('error', isError);
        if (messageTitle) messageTitle.textContent = title;
        if (messageText) messageText.textContent = text;
    }
    if (loader) loader.style.display = 'none';
}

function hideAllSections() {
    if (registrationForm) registrationForm.style.display = 'none';
    if (verificationArea) verificationArea.classList.remove('active');
    if (successMessage) successMessage.classList.remove('active');
    if (messageArea) messageArea.classList.remove('active');
    if (formTitle) formTitle.style.display = 'none';
}

// --- Step 1 Form Validation Functions ---
function validateStudentId() {
    if (!studentIdInput) return false;
    const studentIdRegex = /^\d{8}$/;
    const isValid = studentIdRegex.test(studentIdInput.value);
    if (studentIdError) {
        studentIdError.textContent = isValid ? '' : '請輸入有效的8碼數字學號';
        studentIdError.classList.toggle('active', !isValid);
    }
    studentIdInput.style.borderColor = isValid ? 'var(--input-focus-border)' : 'var(--error-color)';
    return isValid;
}
function validatePasswordFormat() {
    if (!passwordInput) return false;
    const passwordRegex = /^\d{4}$/;
    const isValid = passwordRegex.test(passwordInput.value);
    if (passwordError) {
        passwordError.textContent = isValid ? '' : '密碼必須為4碼數字';
        passwordError.classList.toggle('active', !isValid);
    }
    passwordInput.style.borderColor = isValid ? 'var(--input-focus-border)' : 'var(--error-color)';
    return isValid;
}
function validateConfirmPassword() {
    if (!confirmPasswordInput || !passwordInput) return false;
    const isValid = confirmPasswordInput.value === passwordInput.value;
    if (confirmPasswordError) {
        confirmPasswordError.textContent = isValid ? '' : '兩次輸入的密碼不一致';
        confirmPasswordError.classList.toggle('active', !isValid);
    }
    confirmPasswordInput.style.borderColor = isValid ? 'var(--input-focus-border)' : 'var(--error-color)';
    return isValid;
}
if (studentIdInput) studentIdInput.addEventListener('blur', () => validateStudentId());
if (passwordInput) passwordInput.addEventListener('blur', () => validatePasswordFormat());
if (confirmPasswordInput) confirmPasswordInput.addEventListener('blur', () => validateConfirmPassword());
if (studentIdInput) studentIdInput.addEventListener('input', () => {
    if (studentIdError) { studentIdError.textContent = ''; studentIdError.classList.remove('active'); }
    studentIdInput.style.borderColor = 'var(--input-border)';
});
if (passwordInput) passwordInput.addEventListener('input', () => {
    if (passwordError) { passwordError.textContent = ''; passwordError.classList.remove('active'); }
    if (confirmPasswordInput && confirmPasswordInput.value !== '') validateConfirmPassword();
    passwordInput.style.borderColor = 'var(--input-border)';
});
if (confirmPasswordInput) confirmPasswordInput.addEventListener('input', () => {
    if (confirmPasswordError) { confirmPasswordError.textContent = ''; confirmPasswordError.classList.remove('active'); }
    validateConfirmPassword();
});

// --- Registration Check Logic (Step 1.5) ---
async function checkRegistrationStatus() {
    if (!currentRandomCode) { showMessage('內部錯誤', '隨機碼遺失，請重新嘗試。', true); return; }
    registrationCheckAttempts++;
    console.log(`Checking registration sheet for code: ${currentRandomCode}, attempt ${registrationCheckAttempts}/${registrationMaxAttempts}`);
    if (registrationCheckAttempts > registrationMaxAttempts) { clearInterval(registrationCheckIntervalId); showMessage('檢查失敗', '網路狀況不佳或檢查超時，請稍後再試。', true); return; }
    try {
        const response = await fetch(registrationCheckSheetUrl); // Uses fetched URL
        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
        const data = await response.text();
        const rows = data.split('\n').slice(1);
        let found = false, canProceed = false;
        for (const row of rows) {
            const columns = row.split(',').map(col => col.replace(/^"|"$/g, '').trim());
            const sheetCode = columns[1], status = columns[2];
            if (sheetCode === currentRandomCode) { found = true; canProceed = (status === 'TRUE'); break; }
        }
        if (found) {
            clearInterval(registrationCheckIntervalId);
            if (loader) loader.style.display = 'none';
            if (canProceed) {
                console.log('Registration check successful! Proceeding to verification.');
                if (formTitle) { formTitle.style.display = 'block'; formTitle.textContent = '驗證您的帳號'; }
                if (verificationArea) { verificationArea.classList.add('active'); setTimeout(() => { if (verificationCodeInput) verificationCodeInput.focus(); }, 300); }
            } else {
                console.log('Registration check failed: Student ID already registered.');
                showMessage('註冊失敗', '您的學號已經註冊過，請重新嘗試或登入。', true);
            }
        }
    } catch (error) {
        console.error('Error checking Registration Sheet 2:', error);
        if (registrationCheckAttempts >= registrationMaxAttempts) { clearInterval(registrationCheckIntervalId); showMessage('網路錯誤', '無法連接到伺服器檢查註冊記錄，請稍後再試。', true); }
    }
}

// --- Step 1 Form Submission ---
if (registrationForm) {
    registrationForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        const isStudentIdValid = validateStudentId(), isPasswordValid = validatePasswordFormat(), isConfirmPasswordValid = validateConfirmPassword();
        if (isStudentIdValid && isPasswordValid && isConfirmPasswordValid) {
            if (loader) loader.style.display = 'flex';
            hideAllSections();
            currentRandomCode = generateRandomCode(23);
            if (randomCodeField1) randomCodeField1.value = currentRandomCode;
            if (randomCodeField2) randomCodeField2.value = currentRandomCode;
            const ipAddressVal = await getIPAddress();
            if (ipAddressField) ipAddressField.value = ipAddressVal;
            const studentIdVal = studentIdInput.value, passwordVal = passwordInput.value, randomCodeVal = randomCodeField1.value, ipAddressGoogleFormsEntry = ipAddressField ? ipAddressField.name : null;
            const prefixedStudentId = '#' + studentIdVal, prefixedPassword = '#' + passwordVal;
            let formDataBody = '';
            const studentIdEntryName = studentIdInput.name, passwordEntryName = passwordInput.name, randomCodeEntryName = randomCodeField1.name;
            if (studentIdEntryName) formDataBody += `${studentIdEntryName}=${encodeURIComponent(prefixedStudentId)}`;
            if (passwordEntryName) { if (formDataBody) formDataBody += '&'; formDataBody += `${passwordEntryName}=${encodeURIComponent(prefixedPassword)}`; }
            if (randomCodeEntryName) { if (formDataBody) formDataBody += '&'; formDataBody += `${randomCodeEntryName}=${encodeURIComponent(randomCodeVal)}`; }
            if (ipAddressGoogleFormsEntry && ipAddressVal !== '無法獲取IP地址') { if (formDataBody) formDataBody += '&'; formDataBody += `${ipAddressGoogleFormsEntry}=${encodeURIComponent(ipAddressVal)}`; }
            await fetch(registrationFormUrl, { method: 'POST', body: formDataBody, headers: { 'Content-Type': 'application/x-www-form-urlencoded' }, mode: 'no-cors' }); // Uses fetched URL
            console.log('First Google Form submitted.');
            if (formTitle) { formTitle.style.display = 'block'; formTitle.textContent = '正在檢查註冊紀錄...'; }
            setTimeout(() => { registrationCheckAttempts = 0; registrationCheckIntervalId = setInterval(checkRegistrationStatus, registrationCheckInterval); checkRegistrationStatus(); }, 1000);
        } else { validateStudentId(); validatePasswordFormat(); validateConfirmPassword(); }
    });
}

// --- Verification Status Check Logic (Step 2.5) ---
async function checkVerificationStatus() {
    if (!currentRandomCode) { showMessage('內部錯誤', '隨機碼遺失，請重新嘗試。', true); return; }
    verificationCheckAttempts++;
    console.log(`Checking verification sheet for code: ${currentRandomCode}, attempt ${verificationCheckAttempts}/${verificationMaxAttempts}`);
    if (verificationCheckAttempts > verificationMaxAttempts) { clearInterval(verificationCheckIntervalId); showMessage('驗證失敗', '網路狀況不佳或驗證超時，請稍後再試。', true); return; }
    try {
        const response = await fetch(verificationSheetUrl); // Uses fetched URL
        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
        const data = await response.text();
        const rows = data.split('\n').slice(1);
        let found = false, isValid = false;
        for (const row of rows) {
            const columns = row.split(',').map(col => col.replace(/^"|"$/g, '').trim());
            const sheetCode = columns[0], status = columns[1];
            if (sheetCode === currentRandomCode) { found = true; isValid = (status === 'TRUE'); break; }
        }
        if (found) {
            clearInterval(verificationCheckIntervalId);
            if (loader) loader.style.display = 'none';
            if (isValid) { if (successMessage) successMessage.classList.add('active'); }
            else { showMessage('驗證碼錯誤', '您輸入的驗證碼不正確，請檢查信箱後再試。', true); }
        }
    } catch (error) {
        console.error('Error checking Verification Google Sheet 1:', error);
        if (verificationCheckAttempts >= verificationMaxAttempts) { clearInterval(verificationCheckIntervalId); showMessage('網路錯誤', '無法連接到驗證伺服器，請稍後再試。', true); }
    }
}

// --- Step 2 Form Submission Functions ---
async function submitVerificationData() {
    if (!verificationForm) { showMessage('內部錯誤', '無法找到驗證表單。', true); return; }
    const formData = new FormData(verificationForm);
    if (loader) loader.style.display = 'flex';
    hideAllSections();
    if (formTitle) { formTitle.style.display = 'block'; formTitle.textContent = '正在提交驗證碼...'; }
    try {
        await fetch(verificationFormUrl, { method: 'POST', body: formData, mode: 'no-cors' }); // Uses fetched URL
        console.log('Second Google Form submitted.');
        setTimeout(() => { verificationCheckAttempts = 0; verificationCheckIntervalId = setInterval(checkVerificationStatus, verificationCheckInterval); checkVerificationStatus(); }, 1000);
    } catch (error) {
        console.error('提交驗證碼表單時發生錯誤:', error);
        showMessage('提交失敗', '無法提交驗證碼，請稍後再試。', true);
    }
}

if (verificationForm) {
    verificationForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        if (!verificationCodeInput || verificationCodeInput.value.trim() === '') {
            if(verificationCodeError) { verificationCodeError.textContent = '請輸入驗證碼'; verificationCodeError.classList.add('active'); }
            verificationCodeInput.style.borderColor = 'var(--error-color)';
            return;
        } else {
            if(verificationCodeError) { verificationCodeError.textContent = ''; verificationCodeError.classList.remove('active'); }
            verificationCodeInput.style.borderColor = 'var(--input-border)';
        }
        submitVerificationData();
    });
    if (verificationCodeInput) verificationCodeInput.addEventListener('input', () => {
        if (verificationCodeError) { verificationCodeError.textContent = ''; verificationCodeError.classList.remove('active'); }
        verificationCodeInput.style.borderColor = 'var(--input-border)';
    });
}

// --- Interactive effects for all form inputs ---
const formInputs = document.querySelectorAll('.form-control');
formInputs.forEach(input => {
    input.addEventListener('focus', function() {
        const label = this.parentElement.querySelector('label');
        if (label) label.style.color = 'var(--link-color)';
    });
    input.addEventListener('blur', function() {
        const label = this.parentElement.querySelector('label');
        if (label) label.style.color = 'var(--text-light)';
        if (this.id === 'studentId') validateStudentId();
        if (this.id === 'password') validatePasswordFormat();
        if (this.id === 'confirmPassword') validateConfirmPassword();
        if (this.id === 'verificationCode') {
            if (this.value.trim() === '') {
                if(verificationCodeError) { verificationCodeError.textContent = '請輸入驗證碼'; verificationCodeError.classList.add('active'); }
                this.style.borderColor = 'var(--error-color)';
            } else {
                if(verificationCodeError) { verificationCodeError.textContent = ''; verificationCodeError.classList.remove('active'); }
                this.style.borderColor = 'var(--input-border)';
            }
        }
    });
    input.style.borderColor = 'var(--input-border)';
});

// --- Three.js Background Initialization ---
function initThreeJS() {
    console.log('Initializing Three.js background...');
    const scene = new THREE.Scene();
    const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
    const renderer = new THREE.WebGLRenderer({ antialias: true });

    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.setClearColor(0x000010, 1); // Dark background
    const constellationBg = document.getElementById('constellation-bg');
    if (constellationBg) {
        while(constellationBg.firstChild) {
              constellationBg.removeChild(constellationBg.firstChild);
        }
        constellationBg.appendChild(renderer.domElement);
    } else {
        const existingCanvas = document.querySelector('canvas');
        if (existingCanvas) existingCanvas.remove();
        document.body.appendChild(renderer.domElement);
    }

    // Add random stars
    const starGeometry = new THREE.BufferGeometry();
    const starMaterial = new THREE.PointsMaterial({ color: 0xffffff, size: 0.5 });
    const starVertices = [];

    for (let i = 0; i < 500; i++) {
        const x = (Math.random() - 0.5) * 2000;
        const y = (Math.random() - 0.5) * 2000;
        const z = (Math.random() - 0.5) * 2000;
        starVertices.push(x, y, z);
    }

    starGeometry.setAttribute('position', new THREE.Float32BufferAttribute(starVertices, 3));
    const stars = new THREE.Points(starGeometry, starMaterial);
    scene.add(stars);

    camera.position.z = 5;

    // Animation loop
    function animate() {
        requestAnimationFrame(animate);
        renderer.render(scene, camera);
    }
    animate();

    // Handle window resize
    window.addEventListener('resize', () => {
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
    });
}

// --- [MODIFICATION]：Page Initialization Logic ---
document.addEventListener('DOMContentLoaded', () => {
    // Step 1: Update button text to show loading state
    const submitButton = document.getElementById('submitBtnStep1');
    if (submitButton) {
        submitButton.textContent = '載入設定中...';
    }

    // Step 2: Execute fetchConfig to get URLs and IDs from the backend
    fetchConfig();

    // Step 3: Initialize the Three.js background
    initThreeJS();
});
    </script>
    <!-- END: 註冊表單的 JavaScript 邏輯 -->

</body>
</html>