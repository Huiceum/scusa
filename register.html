<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>關於我們 - 東吳大學學生會</title>
    <link rel="stylesheet" href="style_phone.css">
    <link rel="stylesheet" href="menu.css">
    <link rel="icon" href="favicon.PNG" type="image/x-icon">
</head>

<style>
        /* 當顯示提示框時，頁面樣式 */
        .popup {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            font-size: 20px;
        }
        .popup-message {
            background-color: #333;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }

</style>
<body>
    <div class="container">
        <!-- 漢堡選單按鈕 -->
        <div class="hamburger-menu" id="hamburger-menu">
            <span></span>
            <span></span>
            <span></span>
        </div>

        <nav class="sidebar" id="sidebar">
            <div class="logo">
                <img src="logo.png" alt="Logo">
                <div class="site-name"></div>
            </div>

            <ul class="nav-links">
                <li>
                    <div class="main-menu" data-target="#submenu-1">東吳大學學生會</div>
                    <ul class="submenu" id="submenu-1">
                        <li><a href="東吳大學學生會main_phone.html">首頁</a></li>
                        <li><a href="東吳大學學生會introduction_phone.html">本會簡介</a></li>
                        <li><a href="東吳大學學生會financial-report_phone.html">財務報告</a></li>
                        <li><a href="東吳大學學生會about_phone.html">組織架構</a></li>
                        <li><a href="東吳大學學生會regulations_phone.html">法規彙編</a></li>
                        <li><a href="東吳大學學生會反映表單－公開phone.html">我要反映</a></li> 
                    </ul>
                </li>
                <li>
                    <div class="main-menu" data-target="#submenu-2">活動專區</div>
                    <ul class="submenu" id="submenu-2">
                        <li><a href="東吳大學學生會shop.html">特約商店</a></li>
                    </ul>
                </li>
                <li>
                    <div class="main-menu" data-target="#submenu-3">學生議會</div>
                    <ul class="submenu" id="submenu-3">
                        <li><a href="東吳大學學生議會_phone.html">東吳大學學生議會</a></li>
                        <li><a href="東吳大學學生議會－會議資料_phone.html">東吳大學學生議會－會議資料</a></li>
                        <li><a href="東吳大學學生議會－議員對照表_phone.html">東吳大學學生議會－議員對照表</a></li>
                    </ul>
                </li>
            </ul>
        </nav>



        <div id="popup" class="popup" style="display: none;">
            <div class="popup-message">
                請使用 LINE App 開啟此網頁
            </div>
        </div>
        


  </div>
    <!-- JavaScript -->
    <script>
        
        // 檢測用戶是否在 LINE app 打開網頁
        function isLineApp() {
            return /line/i.test(navigator.userAgent);
        }

        // 進行 LINE 第三方驗證的重定向
        function redirectToLINE() {
            const lineAuthURL = "https://access.line.me/oauth2/v2.1/authorize?response_type=code&client_id=2006561396&redirect_uri=https://scusa.netlify.app/東吳大學registersecond.html&state=paopao000&scope=profile%20openid";
            window.location.href = lineAuthURL;
        }

        // 讀取 URL 的查詢參數
        function getURLParams() {
            const params = new URLSearchParams(window.location.search);
            return {
                code: params.get('code'),
                state: params.get('state')
            };
        }

        // 根據 URL 中的 code 和 state 參數處理結果
        const params = getURLParams();
        if (params.code && params.state === 'paopao000') {
            // 若已經成功認證並且狀態匹配，顯示認證成功
            document.getElementById('popup').style.display = 'none';
            alert("認證成功！您的 LINE 帳號已經綁定！");
        } else {
            // 若沒有認證或狀態不匹配，顯示提示框並要求開啟 LINE
            if (!isLineApp()) {
                document.getElementById('popup').style.display = 'flex';
            } else {
                // 若在 LINE App 開啟，則進行重定向
                redirectToLINE();
            }
        }

        function getLineUserData(code) {
    const accessTokenURL = 'https://api.line.me/oauth2/v2.1/token';
    const secret = '53821e73868139b8913adfc68afbca69';  // 你的secret

    // 用code換取access token
    fetch(accessTokenURL, {
        method: 'POST',
        body: new URLSearchParams({
            grant_type: 'authorization_code',
            code: code,
            redirect_uri: 'https://scusa.netlify.app/register.html',  // 你的redirect URI
            client_id: '2006561396',  // 你的client_id
            client_secret: secret
        })
    })
    .then(response => response.json())
    .then(data => {
        // 獲取access token，並使用它來查詢用戶資料
        const accessToken = data.access_token;
        getUserProfile(accessToken);
    });
}

function getUserProfile(accessToken) {
    // 使用access token來獲取用戶資料
    fetch('https://api.line.me/v2/profile', {
        headers: {
            Authorization: `Bearer ${accessToken}`
        }
    })
    .then(response => response.json())
    .then(userData => {
        const userId = userData.userId;
        const userName = userData.displayName;
        
        // 查詢Google試算表中的用戶資料
        checkUserInSpreadsheet(userId, userName);
    });
}



function checkUserInSpreadsheet(userId, userName) {
    const sheetId = '11X653d3Z4Nepgj63I7CRuRpuXlwqqb3TjmyY1kZZ75M';  // 試算表ID
    const url = `https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?tqx=out:csv`;

    fetch(url)
        .then(response => response.ok ? response.text() : Promise.reject('Error'))
        .then(data => {
            const rows = data.split('\n').slice(1); // 忽略第一行標題

            let found = false;
            let points = '';

            rows.forEach(row => {
                const [user, id, point] = row.split(',').map(col => col.replace(/"/g, '').trim());
                if (id === userId) {
                    found = true;
                    points = point;
                }
            });

            if (found) {
                // 顯示用戶點數
                showUserPoints(points);
            } else {
                // 顯示表單
                showRegistrationForm(userId, userName);
            }
        })
        .catch(error => console.error('Error fetching spreadsheet data:', error));
}

function showUserPoints(points) {
    // 顯示用戶的點數
    alert(`您的點數：${points}`);
}

function showRegistrationForm(userId, userName) {
    // 顯示表單
    const formHTML = `
        <form id="registration-form">
            <label for="line-id">Line用戶：</label>
            <input type="text" id="line-id" value="${userId}" readonly />
            <label for="line-name">Line ID：</label>
            <input type="text" id="line-name" value="${userName}" readonly />
            <label for="email">電子信箱：</label>
            <input type="email" id="email" required />
            <label for="student-id">學號：</label>
            <input type="text" id="student-id" required />
            <label for="name">姓名：</label>
            <input type="text" id="name" required />
            <button type="submit">送出</button>
        </form>
    `;
    document.getElementById('popup').innerHTML = formHTML;

    // 提交表單
    document.getElementById('registration-form').addEventListener('submit', function(event) {
        event.preventDefault();

        // 取得表單數據
        const email = document.getElementById('email').value;
        const studentId = document.getElementById('student-id').value;
        const name = document.getElementById('name').value;

        // 提交到Google表單
        submitToGoogleForm(userId, userName, email, studentId, name);
    });
}

function submitToGoogleForm(userId, userName, email, studentId, name) {
    const formURL = 'https://docs.google.com/forms/d/e/1FAIpQLSe0LThCK7D9Jcw5LhzDwhq7tyHKLlerQUJ8y74IXr28b0oxWQ/formResponse';

    const formData = new FormData();
    formData.append('entry.1048330234', userName);  // 用戶名稱
    formData.append('entry.198592715', userId);  // 用戶ID
    formData.append('entry.1195054574', email);  // 電子信箱
    formData.append('entry.965213465', studentId);  // 學號
    formData.append('entry.1517666082', name);  // 姓名

    fetch(formURL, {
        method: 'POST',
        body: formData
    })
    .then(response => response.ok ? alert('註冊成功！') : alert('註冊失敗！'))
    .catch(error => console.error('Error submitting form:', error));
}





// 當文檔滑入視窗時，添加 'show' 類別以觸發動畫
const observer = new IntersectionObserver((entries) => {
    entries.forEach(entry => {
        // 當元素進入視窗時
        if (entry.isIntersecting) {
            // 為該元素添加 'show' 類別以觸發動畫
            entry.target.classList.add('show');
        } else {
            // 可選：當元素不再進入視窗時，可以移除 'show' 類別
            entry.target.classList.remove('show');
        }
    });
});

// 監視所有具有 slide-up 類別的元素
document.querySelectorAll('.slide-up').forEach(element => {
    observer.observe(element);
});

// 餐包菜單和側邊欄的設定（未變更）
const hamburgerMenu = document.getElementById('hamburger-menu');
const sidebar = document.getElementById('sidebar');
const mainMenus = document.querySelectorAll('.main-menu');

        // 漢堡選單功能：顯示或隱藏側邊欄
        hamburgerMenu.addEventListener('click', function() {
            sidebar.classList.toggle('active');
        });

        // 點擊主選單顯示或隱藏副選單
        mainMenus.forEach(menu => {
            menu.addEventListener('click', function() {
                const targetSubmenu = document.querySelector(menu.getAttribute('data-target'));
                targetSubmenu.classList.toggle('show');
            });
        });
        // 當文檔加載完成後的事件
        document.addEventListener('DOMContentLoaded', function() {
            loadIcons(); // 載入公告
        });

        function loadIcons() {
    const sheetId = '18WW9PLenRd6MSn2pRSBKSQ2yb70CqP027hbjRZ7WjEg'; // 替換為您的試算表 ID
    const url = `https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?tqx=out:csv`;

    fetch(url)
        .then(response => response.ok ? response.text() : Promise.reject('Network response was not ok'))
        .then(data => {
            const rows = data.split('\n').slice(1); // 分割行並移除標題行
            const iconContainer = document.querySelector('.icon-container');
            iconContainer.innerHTML = ''; // 清空圖示區域

            rows.forEach(row => {
                const [imageUrl, text, link] = row.split(',').map(col => col.replace(/"/g, '').trim()); // 解析每一行

                if (imageUrl && text && link) {
                    const icon = document.createElement('div');
                    icon.classList.add('icon');

                    icon.innerHTML = `
                        <a href="${link}" target="_blank">
                            <img src="${imageUrl}" alt="${text}">
                            <div class="icon-text">${text}</div>
                        </a>
                    `;
                    iconContainer.appendChild(icon);
                }
            });
        })
        .catch(error => console.error('Error loading icons:', error));
}




    
    </script>
</body>
</html>
