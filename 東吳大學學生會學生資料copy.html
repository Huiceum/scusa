<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>即時點數查詢</title>
    <!-- 引入 qrcode.js -->
    <script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // 從 sessionStorage 獲取 user 和 randomCode
            const user = sessionStorage.getItem('user');
            const randomCode = sessionStorage.getItem('randomCode');

            if (!user || !randomCode) {
                document.getElementById('message').textContent = "無法獲取資料，請確保您已登入。";
                return;
            }

            document.getElementById('points').innerHTML = "載入點數中...";


            // 生成 QR code
            generateQRCode(randomCode);

            // 不斷輪詢試算表，直到找到匹配的資料
            pollSpreadsheet(user, randomCode);
        });

        // 生成 QR code 的函式
        function generateQRCode(code) {
            const qrContainer = document.getElementById('qrcode');
            QRCode.toCanvas(qrContainer, code, function (error) {
                if (error) {
                    console.error('QR code 生成失敗:', error);
                }
            });
        }

        // 試算表輪詢函式
        function pollSpreadsheet(user, randomCode) {
            const sheetId = '1ADpHD124E0PVZSCJlxMDasUsM7Wmc_7hc-_SUiYR1dg';
            const url = `https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?tqx=out:csv`;

            function checkSpreadsheet() {
                fetch(url)
                    .then(response => response.ok ? response.text() : Promise.reject('無法連接試算表'))
                    .then(data => {
                        const rows = data.split('\n').map(row => row.split(',').map(col => col.replace(/"/g, '').trim()));
                        const headers = rows[0]; // 第一排是標題行
                        const userIndex = rows.findIndex(row => row[0] === user && row[1] === randomCode);

                        if (userIndex > 0) { // 找到匹配的資料行
                            const userRow = rows[userIndex];
                            let pointsText = '';
                            for (let i = 2; i < headers.length; i++) {
                                if (userRow[i]) {
                                    pointsText += `${headers[i]}: ${userRow[i]}<br>`;
                                }
                            }

                            if (pointsText) {
                                document.getElementById('points').innerHTML = `您目前的點數：<br>${pointsText}`;
                            } else {
                                document.getElementById('points').textContent = `找到匹配的用戶，但沒有點數資料。`;
                            }
                            clearInterval(pollingInterval); // 停止輪詢
                        } else {
                            console.log('尚未找到匹配資料，將繼續查詢...');
                        }
                    })
                    .catch(error => {
                        console.error('無法檢索試算表資料:', error);
                    });
            }

            const pollingInterval = setInterval(checkSpreadsheet, 3000); // 每 3 秒查詢一次試算表
        }
    </script>
</head>
<body>
    <h1>即時點數查詢</h1>
    <p id="message"></p>
    <canvas id="qrcode"></canvas>
    <p id="points"></p>
</body>
</html>
